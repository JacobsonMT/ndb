<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE composition PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<ui:composition template="/WEB-INF/templates/mainTemplate.xhtml"
    xmlns="http://www.w3.org/1999/xhtml"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:fn="http://java.sun.com/jsp/jstl/functions"
	xmlns:p="http://primefaces.org/ui"
	xmlns:c="http://java.sun.com/jsp/jstl/core">

	<ui:define name="pageTitle">Results</ui:define>
	
	<ui:define name="css">
		<h:outputStylesheet library="css" name="index.css" />
	</ui:define>
	
	<ui:define name="content">

	<br/>
	<p:growl id="msgs" showDetail="true" />
    <h3 style="margin-top:0">Results for  <h:outputText value="#{resultsView.query}" /> </h3>
		<h:form id="formResults">
		    <p:dataTable id="tbl" 
		    			 var="events" value="#{resultsView.events}"
		                 paginatorTemplate="{Exporters}"
		                 rowExpandMode="single"
		                 paginator="true" rows="25" style="margin-bottom:20px">
		 
		        <f:facet name="{Exporters}">
		            <h:commandLink>
		                <p:graphicImage library="img" name="excel.png" width="24"/>
		                <p:dataExporter type="xls" target="tbl" fileName="mutations" />
		            </h:commandLink>
		 		
		            <h:commandLink>
		                <p:graphicImage library="img" name="pdf.png" width="24"/>
		                <p:dataExporter type="pdf" target="tbl" fileName="mutations"/>
		            </h:commandLink>
		 
		            <h:commandLink>
		                <p:graphicImage library="img" name="csv.png" width="24"/>
		                <p:dataExporter type="csv" target="tbl" fileName="mutations" />
		            </h:commandLink>
		 
		            <h:commandLink>
		                <p:graphicImage library="img" name="xml.png" width="24"/>
		                <p:dataExporter type="xml" target="tbl" fileName="mutations" />
		            </h:commandLink>
		        </f:facet>
		 
		        <p:column>
		            <f:facet name="header">
		                <h:outputText id="Id" value="Id" />
    					<p:tooltip id="toolTipId" for="Id" value="Database identifier for each variant." />		                
		            </f:facet>
		            <h:outputLink value="variant.xhtml?id=#{events.eventId}">
						<h:outputText value="#{events.eventId}" />
					</h:outputLink>		        
					<p:rowToggler />    
		        </p:column>
 
		 
		        <p:column>
		            <f:facet name="header">
		                <h:outputText id="Gene" value="Gene"/>
		                <p:tooltip id="toolTipGene" for="Gene" value="Gene symbol on which the variant is located" />
		            </f:facet>
					
		            <center> 
		            	
		            	<ui:repeat var="symbols" value="#{events.symbols.entrySet().toArray()}" varStatus="statusRepeatGenes">		            		      
		            		<h:outputText value="#{symbols.key}" />		  
							<h:outputText value="&nbsp;"/>	          		
		            		<ui:repeat var="x" value="#{symbols.value.xrefs.toArray()}">		            				            			 
		            			<h:outputLink target="_blank" value="http://GRCH37.ensembl.org/Homo_sapiens/Gene/Summary?db=core;g=#{fn:substringAfter(x, 'Ensembl:') }">		                
									<h:graphicImage border="5"  library="img" name="ensembl.png" height="15" rendered="#{fn:startsWith(x,'Ensembl:')}" />
        						</h:outputLink>
        						<!--  Assuming every gene has an NCBI entry, let's just add commas when we have an Ensembl ID -->
        						<h:outputText rendered="#{fn:startsWith(x,'Ensembl:')}" value="&nbsp;"/>				            		
		            		</ui:repeat>	        		            			            				            		
		            		<h:outputLink target="_blank" value="http://www.ncbi.nlm.nih.gov/gene/#{symbols.value.geneId}">		                
									<h:graphicImage border="5"  library="img" name="NCBI.gif" width="30"/>
							</h:outputLink>      	
							<h:outputText value="&lt;br/&gt;" escape="false"  rendered="#{not statusRepeatGenes.last}" />			
		            	</ui:repeat>		        
		            </center>
		            		 
		        </p:column>
		        		       
		        <p:column>
		            <f:facet name="header">
		                <h:outputText id="Subject" value="Subject"/>
		                <p:tooltip id="toolTipSubject" for="Subject" value="NDB-specific identifier for the proband source of the variant." />
		            </f:facet>
		            <h:outputText value="#{events.subjectId}" />		            
		        </p:column>
		        
		         <p:column>
		            <f:facet name="header">
		                <h:outputText id="Location" value="Location"/>
		                <p:tooltip id="toolTipLocation" for="Location" value="Location of the variant" />
		            </f:facet>
		            <h:outputLink value="https://genome.ucsc.edu/cgi-bin/hgTracks?db=hg19&amp;position=chr#{events.chromosome}%3A#{events.startHg19}-#{events.stopHg19}">			            	
		            	<h:outputText value="chr#{events.chromosome}:#{events.startHg19}-#{events.stopHg19}" />
		            </h:outputLink>
		        </p:column>		             
		        
		        <ui:remove>
		         <p:column>
		            <f:facet name="header">
		                <h:outputText id="CHR" value="CHR"/>
		                <p:tooltip id="toolTipCHR" for="CHR" value="Chromosome affected by the variant" />
		            </f:facet>
		            <h:outputText value="#{mutation.chromosome}" />
		        </p:column>
		               
		        <p:column>
		            <f:facet name="header">
		                <h:outputText id="Start" value="Start"/>
		                <p:tooltip id="toolTipStart" for="Start" value="Start coordinate (inclusive) of the REF under Hg19" />
		            </f:facet>
		            <h:outputLink value="https://genome.ucsc.edu/cgi-bin/hgTracks?db=hg19&amp;position=chr#{mutation.chromosome}%3A#{mutation.startHg19}-#{mutation.stopHg19}">	
		            	<h:outputText value="#{mutation.startHg19}" />
		            </h:outputLink>	  
		        </p:column>
		        
		        <p:column>
		            <f:facet name="header">
		                <h:outputText id="Stop" value="Stop"/>
		            	<p:tooltip id="toolTipStop" for="Stop" value="Stop coordinate (inclusive) of the REF under Hg19" />	
		            </f:facet>
		            <h:outputLink value="https://genome.ucsc.edu/cgi-bin/hgTracks?db=hg19&amp;position=chr#{mutation.chromosome}%3A#{mutation.startHg19}-#{mutation.stopHg19}">			            
		            	<h:outputText value="#{mutation.stopHg19}" />
		            </h:outputLink>
		        </p:column>
		        
		        
		        <p:column>
		            <f:facet name="header">
		                <h:outputText id="Effect" value="Effect"/>
		                <p:tooltip id="toolTipEffect" for="Effect" value="Reported variant effect" />	
		           
		            </f:facet>
	            	
	            	<ui:repeat var="c" value="#{mutation.categories.toArray()}" varStatus="status">   
	            		<h:outputText value="#{c.label}" /> 
	            		
	            		&nbsp;
	            		<h:outputText value="" rendered="#{not status.last}" /> 	            		          			            			          
	            	</ui:repeat>	            	
		        </p:column>
		        </ui:remove>
		        
		        <p:column>
		            <f:facet name="header">
		                <h:outputText id="Sources" value="Sources"/>
		                <p:tooltip id="toolTipSources" for="Sources" value="Source(s) where variants from this event are reported." />		           
		            </f:facet>
		           
		            <ui:repeat var="paper" value="#{events.authors.entrySet().toArray()}" varStatus="status">   
	            		 <h:outputLink value="#{paper.value}">			            
		            		<h:outputText value="#{paper.key}" />
		            	</h:outputLink>
	            		<h:outputText value="&nbsp;" rendered="#{not status.last}" /> 	            		          			            			          
	            	</ui:repeat>	 
	            	
		            <br/>
		        </p:column>
		    
	            		 	 
			    <p:rowExpansion>   
			    <!-- Show 'also reported as' -->	
			    <ui:remove>
			    <p:dataGrid var="v" value="#{events.variants}" columns="3" layout="grid" rows="12">
			 
			        <f:facet name="header">
			            Cars for Sale
			        </f:facet>
			 
			        <p:panel header="#{v.id}" style="text-align:center">
			            <h:panelGrid columns="1" style="width:100%">
			 
			                <h:outputText value="#{v.ref}" />
			
			            </h:panelGrid>
			        </p:panel>
 
    			</p:dataGrid>
    			</ui:remove>	   
					<p:dataTable id="innerTbl" styleClass="innerTblCls" var="variants" value="#{events.variants}"
			                 paginator="false" rows="25" style="margin-bottom:20px" >		       
				 
				        <p:column>
				            <f:facet name="header">
				                <h:outputText id="InnerId" value="Id" />
		    					<p:tooltip id="toolTipInnerId" for="InnerId" value="Database unique identifier for each variant of an event." />		                
				            </f:facet>
							<h:outputText value="#{variants.id}" />
						</p:column>
						
						 <p:column>
				            <f:facet name="header">
				                <h:outputText id="SampleId" value="SampleId" />
		    					<p:tooltip id="toolTipSampleId" for="SampleId" value="Reported proband identifier." />		                
				            </f:facet>
							<h:outputText value="#{variants.sampleId}" />
						</p:column>
						
						<p:column style="min-width:8px;">
				            <f:facet name="header">
				                <h:outputText id="REF" value="REF"/>
				                <p:tooltip id="toolTipREF" for="REF" value="Reference base(s) affected by the variant" />
				            </f:facet>
				            <h:outputText value="#{variants.ref}" />
				        </p:column>
				        
				        <p:column>
				            <f:facet name="header">
				                <h:outputText id="ALT" value="ALT"/>
				                <p:tooltip id="toolTipALT" for="ALT" value="Modified base(s) caused by the variant" />
				            </f:facet>
				            <h:outputText value="#{variants.alt}" />
				        </p:column>
				        <p:column>
				            <f:facet name="header">
				                <h:outputText id="Start" value="Start"/>
				                <p:tooltip id="toolTipStart" for="Start" value="Start coordinate (inclusive) of the REF under Hg19" />
				            </f:facet>
				            <h:outputLink value="https://genome.ucsc.edu/cgi-bin/hgTracks?db=hg19&amp;position=chr#{variants.chromosome}%3A#{variants.startHg19}-#{variants.stopHg19}">	
				            	<h:outputText value="#{variants.startHg19}" />
				            </h:outputLink>	  
				        </p:column>
				        
				        <p:column>
				            <f:facet name="header">
				                <h:outputText id="Stop" value="Stop"/>
				            	<p:tooltip id="toolTipStop" for="Stop" value="Stop coordinate (inclusive) of the REF under Hg19" />	
				            </f:facet>
				            <h:outputLink value="https://genome.ucsc.edu/cgi-bin/hgTracks?db=hg19&amp;position=chr#{variants.chromosome}%3A#{variants.startHg19}-#{variants.stopHg19}">			            
				            	<h:outputText value="#{variants.stopHg19}" />
				            </h:outputLink>
				        </p:column>
				        
				         <p:column>
				            <f:facet name="header">
				                <h:outputText id="Source" value="Source"/>
				            	<p:tooltip id="toolTipSource" for="Source" value="Source of the reported variant" />	
				            </f:facet>
				            <h:outputLink value="#{variants.paper.url}">			            
				            	<h:outputText value="#{variants.paper.author}" />
				            </h:outputLink>
				        </p:column>
				        <p:column>
							<f:facet name="header">
					        	<h:outputText id="More" value="More"/>
				                <p:tooltip id="toolTipMore" for="More" value="Click this field for additional data about specific reported variants." />		           
					        </f:facet>
					            
				        	<p:commandLink update=":formResults:variantDetail" 
				        					oncomplete="PF('dlg').show()" 
				        					title="View Details" 
				        					styleClass="ui-icon ui-icon-search" 
				        					style="float:left;
				        					margin-right:10px">
					            <f:setPropertyActionListener value="#{variants}" target="#{resultsView.selectedVariant}" />
					            <h:outputText value="#{variants.rawVariantId}" />
					        </p:commandLink>
					        
					        <h:outputText value="#{variants.rawVariantId}" style="display:inline-block"/>

					        <ui:remove>				            
			    				<p:commandButton value="Source" type="button" onclick="PF('dlg').show();" />
		    				</ui:remove>
		    				
		    				
						</p:column>				
					</p:dataTable>
		        </p:rowExpansion>		 
		    </p:dataTable>
		    	
			<p:dialog header="Source Variant Information" widgetVar="dlg" modal="true" width="500px">
				<p:outputPanel id="variantDetail" >
		    	   		<h:outputText value="Variant reported in: " />
		    	   		<h:outputLink value="#{resultsView.selectedVariant.paper.url}">
		    	   			<h:outputText value="#{resultsView.selectedVariant.paper.author}" />
			       		</h:outputLink>								
					<p:dataList value="#{resultsView.selectedVariant.rawKV.entrySet().toArray()}" var="raw" type="definition" >
			    		<p:outputPanel>
			                <h:panelGrid columns="3" cellpadding="15">
			                	<h:outputText value="#{raw.key} :" style="font-weight: bold"/>
							    <!--  <span>&nbsp;&nbsp;&nbsp;</span> -->
			                    <h:outputText value="#{raw.value}" />	                    
			                </h:panelGrid>
			           </p:outputPanel>	           
			       	</p:dataList>
					
				</p:outputPanel>    
				
			</p:dialog>
		</h:form>
	</ui:define>

</ui:composition>